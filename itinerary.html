<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>길담 · 완성 일정</title>
  <link rel="stylesheet" href="styles.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="config.js"></script>
</head>
<body>

  <!-- 🔄 로딩 스크린 -->
  <div id="loading" class="loading">
    <div class="loading__inner">
      <div class="spinner" aria-hidden="true"></div>
      <div class="loading__text">
        <strong>일정 추천 중…</strong><br>
        입력하신 기간·테마·감정을 반영하고 있어요.
      </div>
      <div class="loading__hint">잠시만 기다려 주세요.</div>
    </div>
  </div>

  <!-- 완료 후 보여줄 실제 화면 -->
  <header class="brand small" id="header" style="display:none;">길담 · 추천 일정</header>

  <div class="layout" id="layout" style="display:none;">
    <section class="left">
      <h2 style="display:flex;justify-content:space-between;align-items:center">
        추천 여행지 목록
        <small id="lockInfo" style="font-weight:600;color:#93c5fd"></small>
      </h2>
      <div id="cards"></div>
      <div class="actions">
        <button class="btn" id="saveCsv">일정 CSV 저장</button>
        <button class="btn secondary" id="resetPlan">다시 만들기</button>
      </div>
    </section>

    <section class="right">
      <!-- ✅ 탭 제거하고 지도만 -->
      <div id="map"></div>
    </section>
  </div>

  <script src="common.js"></script>
  <script>
    // 로딩 토글
    function setLoading(isLoading){
      const loading = document.getElementById('loading');
      const header = document.getElementById('header');
      const layout = document.getElementById('layout');
      if(isLoading){
        loading.style.display = 'grid';
        header.style.display = 'none';
        layout.style.display = 'none';
      }else{
        loading.style.display = 'none';
        header.style.display = '';
        layout.style.display = '';
      }
    }

    // 지도 컨테이너가 표시된 뒤 Leaflet 사이즈 재계산
    function forceMapRefresh(){
      // 두 프레임 뒤에 수행( display:none → block 전환 대응 )
      requestAnimationFrame(()=>requestAnimationFrame(()=>{
        try{
          ensureMap();
          if(window._map){ window._map.invalidateSize(); }
        }catch(e){ /* noop */ }
      }));
    }

    (async function(){
      setLoading(true);

      const purpose = localStorage.getItem('gildam_purpose')||'';
      const themes  = JSON.parse(localStorage.getItem('gildam_themes')||'[]');
      const emotions= JSON.parse(localStorage.getItem('gildam_emotions')||'[]');
      const start   = localStorage.getItem('gildam_start');
      const end     = localStorage.getItem('gildam_end');

      if(!start || !end || !purpose || !themes.length || !emotions.length){
        alert('필수 입력이 누락되었습니다. 처음부터 다시 진행해주세요.');
        location.href='dates.html';
        return;
      }

      const key = planKey({purpose, themes, emotions, start, end});
      const lockInfo = document.getElementById('lockInfo');
      const setLockedUI = (locked, ts) => {
        if(locked){
          const d = ts ? new Date(ts) : null;
        }
      };

      try{
        const ctx = await loadDataset('busan_data.csv');
        const blacklist = await loadBlacklist(window.LLM_CONFIG.blacklistCsv);

        let items = [];
        const cached = loadPlan(key);

        if(cached && cached.items && cached.items.length){
          items = cached.items;
          setLockedUI(true, cached.meta?.savedAt);
        } else {
          // LLM 시도 → 실패 시 로컬
          if(window.LLM_CONFIG.key){
            try{
              const llmItems = await buildPlanLLM(ctx, {purpose, themes, emotions, start, end}, window.LLM_CONFIG.key, blacklist);
              if(llmItems && llmItems.length) items = llmItems;
            }catch(e){ console.warn('LLM 실패, 로컬로 대체', e); }
          }
          if(!items.length){
            items = buildPlanLocal(ctx, {purpose, themes, emotions, start, end}, blacklist);
          }
          savePlan(key, items, {start, end, themes, emotions, usedLLM: !!window.LLM_CONFIG.key});
          setLockedUI(true, Date.now());
        }

        // ✅ 렌더: 카드 + 지도(전체 표시는 common.js의 renderPlan이 담당)
        window.__PLAN_ITEMS__ = items;
        renderPlan(items);

        // 화면 표시 후 지도 사이즈 정렬
        setLoading(false);
        forceMapRefresh();

        // 리사이즈 대응(지속 안정)
        const rightPane = document.querySelector('.right');
        if (rightPane && 'ResizeObserver' in window){
          new ResizeObserver(()=>{ if(window._map){ window._map.invalidateSize(); }}).observe(rightPane);
        }
        window.addEventListener('resize', ()=>{ if(window._map){ window._map.invalidateSize(); }});
        window.addEventListener('orientationchange', ()=>{ setTimeout(()=>{ if(window._map){ window._map.invalidateSize(); }}, 250); });

        // 버튼
        document.getElementById('saveCsv').onclick = () => downloadPlanCsv(items);
        document.getElementById('resetPlan').onclick = () => {
          if(confirm('현재 일정을 삭제하고 처음부터 다시 만들까요?')){
            resetSelections({ clearPlans: true });
            location.href = 'dates.html';
          }
        };
      }catch(err){
        console.error(err);
        alert('일정을 생성하는 중 오류가 발생했어요. 처음으로 돌아갑니다.');
        location.href='dates.html';
      }
    })();
  </script>
</body>
</html>
