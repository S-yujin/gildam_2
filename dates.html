<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>길담 · 여행 기간</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="styles.css" />

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ko.js"></script>

  <style>
    :root{ --brand:#3b82f6; --line:#e5e7eb; --muted:#6b7280; }
    .container{ max-width:720px; margin:0 auto; padding:24px 16px 60px; }
    .brand{ font-weight:800; font-size:20px; margin:12px 0 24px; }
    .stepTitle{ font-size:24px; font-weight:800; margin:6px 0 8px; }
    .desc{ color:var(--muted); margin-bottom:18px; }
    .field{ margin-top:8px; }
    .label{ font-weight:700; margin-bottom:8px; display:block; }
    .input{
      width:100%; padding:12px 14px; border-radius:12px; border:1px solid var(--line);
      font-size:15px; outline:none;
    }
    .input:focus{ border-color:var(--brand); box-shadow:0 0 0 3px rgba(31,111,235,.15); }
    .metaRow{ display:flex; justify-content:space-between; align-items:center; margin-top:8px; }
    .error{ color:#ef4444; font-size:14px; min-height:20px; }
    .hint{ color:var(--muted); font-size:14px; }
    .actions{ display:flex; gap:10px; margin-top:22px; }
    .btn{ padding:12px 16px; border-radius:10px; border:1px solid var(--line); background:#fff; font-weight:700; cursor:pointer; }
    .btn.primary{ background:var(--brand); color:#fff; border-color:var(--brand); }
    .btn:disabled{ opacity:.5; cursor:not-allowed; }
    .inline{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .pill{ background:#f3f4f6; border:1px solid #e5e7eb; padding:6px 10px; border-radius:999px; font-size:13px; cursor:pointer; }
    .pill:hover{ background:#eef2ff; border-color:#c7d2fe; }
  </style>
</head>
<body class="centered">
  <div class="container">
    <header class="brand">길담 · 여행 기간</header>

    <h1 class="stepTitle">언제 떠나시나요?</h1>
    <p class="desc">과거 날짜는 선택할 수 없어요. 한 번에 <b>기간</b>을 선택하세요.</p>

    <div class="field">
      <label class="label" for="dateRange">여행 기간</label>
      <input id="dateRange" class="input" placeholder="YYYY-MM-DD ~ YYYY-MM-DD" readonly />
      <div class="metaRow">
        <div class="error" id="err"></div>
        <div class="hint" id="summary">일수를 선택하면 여기 표시됩니다.</div>
      </div>
    </div>

    <div class="field">
      <div class="label">빠른 선택</div>
      <div class="inline">
        <button class="pill" data-days="1">당일치기</button>
        <button class="pill" data-days="2">1박2일</button>
        <button class="pill" data-days="3">2박3일</button>
        <button class="pill" data-days="4">3박4일</button>
      </div>
    </div>

    <div class="actions">
      <button class="btn" id="backBtn" type="button">이전</button>
      <button class="btn primary" id="nextBtn" type="button" disabled>다음</button>
      <button class="btn" id="resetBtn" type="button">초기화</button>
    </div>
  </div>

  <script src="common.js"></script>
  <script>
   const fmtLocal = d => {
      if (!(d instanceof Date) || isNaN(+d)) return '';
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,'0');
      const day = String(d.getDate()).padStart(2,'0');
      return `${y}-${m}-${day}`;
    };
    const parseISO = s => { const d = new Date(s + 'T00:00:00'); return isNaN(+d) ? null : d; };

    const rangeInput = document.getElementById('dateRange');
    const errEl = document.getElementById('err');
    const sumEl = document.getElementById('summary');
    const nextBtn = document.getElementById('nextBtn');

    const savedS = localStorage.getItem('gildam_start');
    const savedE = localStorage.getItem('gildam_end');

    let fp = flatpickr("#dateRange", {
      locale: "ko",
      mode: "range",
      dateFormat: "Y-m-d",
      minDate: "today",                 // ✅ 과거 선택 불가
      defaultDate: (savedS && savedE) ? [savedS, savedE] : null,
      onChange: onPickChange
    });

    document.querySelectorAll('.pill[data-days]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const days = parseInt(btn.dataset.days, 10);
        const s = new Date();
        const e = new Date(s); e.setDate(e.getDate() + (days-1));
        fp.setDate([s, e], true);
        onPickChange(fp.selectedDates);
      });
    });

    function validateAndSave(sDate, eDate){
      errEl.textContent = '';
      nextBtn.disabled = true;

      if(!sDate || !eDate){
        sumEl.textContent = '일수를 선택하면 여기 표시됩니다.';
        return;
      }

      if(eDate < sDate){ errEl.textContent = '종료일이 시작일보다 앞설 수 없습니다.'; return; }

      const days = Math.round((eDate - sDate)/(1000*60*60*24)) + 1;
      sumEl.textContent = `${fmtLocal(sDate)} ~ ${fmtLocal(eDate)} · 총 ${days}일`;

      localStorage.setItem('gildam_start', fmtLocal(sDate));
      localStorage.setItem('gildam_end', fmtLocal(eDate));
      nextBtn.disabled = false;
    }

    function onPickChange(selected){
      const [s, e] = selected || [];
      validateAndSave(s, e);
    }

    if(savedS && savedE){
      const s = parseISO(savedS), e = parseISO(savedE);
      if(s && e) validateAndSave(s, e);
    }

    document.getElementById('backBtn').onclick = () => location.href='index.html';
    document.getElementById('nextBtn').onclick = () => location.href='themes.html';
    document.getElementById('resetBtn').onclick = () => {
      resetSelections({ clearPlans: true });
      fp.clear();
      errEl.textContent = '';
      sumEl.textContent = '일수를 선택하면 여기 표시됩니다.';
      nextBtn.disabled = true;
    };
  </script>
</body>
</html>
